<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All-In Prompt Builder (ChatGPT Image Edit)</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --text:#e9edf1; --muted:#a9b3bd;
      --line:#232833; --accent:#2d3c58; --warn:#5a3c2d; --ok:#2d5a45;
    }
    *{ box-sizing:border-box; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,#0b0c10,#090a0d); color:var(--text); }
    header{
      padding:18px 16px; border-bottom:1px solid var(--line);
      position:sticky; top:0; background:rgba(11,12,16,.92); backdrop-filter:blur(10px); z-index:5;
    }
    header h1{ margin:0; font-size:16px; letter-spacing:.3px; }
    header p{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35; }

    main{ max-width:1100px; margin:0 auto; padding:14px 14px 110px; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    @media (min-width:1020px){ .grid{ grid-template-columns:1.1fr .9fr; } }

    .card{
      background:rgba(18,20,26,.92); border:1px solid var(--line); border-radius:14px; padding:14px;
    }
    .card h2{
      margin:0 0 10px; font-size:13px; color:#fff; letter-spacing:.3px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .pill{
      font-size:11px; color:var(--muted); padding:2px 8px; border:1px solid var(--line);
      border-radius:999px; background:#0f1117; white-space:nowrap;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .section{ margin-top:10px; }
    .section-title{
      margin:8px 0 10px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;
    }
    label{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      background:#0f1117; border:1px solid var(--line); border-radius:12px; font-size:12px;
    }
    select, input[type="text"]{
      background:#0f1117; color:var(--text); border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; font-size:13px; outline:none;
    }
    select{ min-width:170px; }
    input[type="text"]{ min-width:240px; flex:1; }
    textarea{
      width:100%; min-height:420px; resize:vertical; white-space:pre-wrap;
      background:#0f1117; color:var(--text); border:1px solid var(--line);
      border-radius:12px; padding:12px; font-size:12.5px; line-height:1.45; outline:none;
    }
    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:1px solid var(--line); background:#0f1117; color:var(--text);
      border-radius:12px; padding:10px 12px; font-size:13px; cursor:pointer;
    }
    button.primary{ background:#1b2433; border-color:var(--accent); }
    button:hover{ filter:brightness(1.08); }
    button.small{ padding:8px 10px; font-size:12px; }
    .note{ color:var(--muted); font-size:12px; line-height:1.45; }
    .divider{ height:1px; background:var(--line); margin:10px 0; }

    .panel{
      border:1px solid var(--line); background:#0f1117; border-radius:12px; padding:10px;
    }
    .panel ul{ margin:6px 0 0 18px; padding:0; color:var(--muted); font-size:12px; }
    .badge{
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px;
      border:1px solid var(--line); background:#0f1117; color:var(--muted);
    }
    .badge.warn{ border-color:var(--warn); color:#f0d3c6; background:rgba(90,60,45,.25); }
    .badge.ok{ border-color:var(--ok); color:#cfe9dc; background:rgba(45,90,69,.25); }

    .footerhint{ position:fixed; bottom:12px; left:12px; right:12px; max-width:1100px; margin:0 auto; z-index:10; }
    .toast{ display:none; padding:10px 12px; border-radius:12px; background:rgba(27,36,51,.95); border:1px solid var(--accent); font-size:12px; }
  </style>
</head>

<body>
<header>
  <h1>All-In Prompt Builder (ChatGPT Image Edit)</h1>
  <p>Auto-saves settings. Focus Targets with guardrails + warnings. Copy Pass 1 / Pass 2 / Both + Fix prompts.</p>
</header>

<main>
  <div class="grid">

    <!-- LEFT: Controls -->
    <div class="card">
      <h2>
        <span>Controls</span>
        <span class="pill" id="statusPill">Loaded</span>
      </h2>

      <div class="section">
        <div class="section-title"><span>Presets</span><span class="pill">One tap</span></div>
        <div class="row">
          <button class="primary" id="presetClean">Full-Frame Clean (Pass 1)</button>
          <button class="primary" id="presetCrisp">Full-Frame Crisp (Pass 1 + Pass 2)</button>
          <button id="presetFast">Single-Pass Fast</button>
          <button id="presetHeadshot">Headshot Drama</button>
        </div>
        <p class="note">“Crisp” is your default: Pass 1 grade + Pass 2 non-skin detail (no blotch).</p>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <div class="section-title">Aspect Ratio</div>
          <select id="aspect">
            <option value="9:16" selected>9:16 (Portrait)</option>
            <option value="16:9">16:9 (Landscape)</option>
          </select>
        </div>

        <div>
          <div class="section-title">Mode</div>
          <select id="mode">
            <option value="pass1" selected>Pass 1 — Full Frame Grade</option>
            <option value="pass2">Pass 2 — Detail Only (Non-skin)</option>
            <option value="single">Single Pass — Grade + Detail (Fast)</option>
            <option value="headshot">Headshot Crop — Controlled Crop</option>
          </select>
        </div>

        <div style="flex:1">
          <div class="section-title">Optional Notes (appended)</div>
          <input id="notes" type="text" placeholder='e.g., keep hat fully visible; slightly stronger shadows' />
        </div>
      </div>

      <div class="section">
        <div class="section-title"><span>Framing Rules</span><span class="badge ok" id="frameBadge">OK</span></div>
        <div class="row">
          <label><input type="checkbox" id="noCrop" checked> Full frame (no crop/zoom/reframe)</label>
          <label><input type="checkbox" id="deepDOF" checked> Deep depth of field (even focus)</label>
          <label><input type="checkbox" id="noRotate" checked> No rotation / no camera angle changes</label>
        </div>
        <p class="note">Headshot mode uses controlled crop rules and ignores “no crop.”</p>
      </div>

      <div class="section">
        <div class="section-title"><span>Locked Features (anti-drift)</span><span class="badge ok" id="lockBadge">OK</span></div>
        <div class="row">
          <label><input type="checkbox" id="lockIdentity" checked> Identity / facial structure locked</label>
          <label><input type="checkbox" id="lockTeeth" checked> Teeth locked</label>
          <label><input type="checkbox" id="lockEyes" checked> Eyes locked</label>
          <label><input type="checkbox" id="lockBeard" checked> Beard shape locked</label>
          <label><input type="checkbox" id="lockTattoos" checked> Tattoos locked</label>
          <label><input type="checkbox" id="lockBody" checked> Body proportions/pose locked</label>
          <label><input type="checkbox" id="lockSkinPixels"> Skin pixels locked (strong)</label>
          <label><input type="checkbox" id="colorLock" checked> Skin tone + neutral WB locked</label>
        </div>
      </div>

      <div class="section">
        <div class="section-title"><span>Focus Targets</span><span class="badge" id="focusBadge">Select what matters</span></div>
        <div class="row">
          <label><input type="checkbox" id="focusSmile"> Smile realism (NO teeth changes)</label>
          <label><input type="checkbox" id="focusTeeth"> Teeth consistency (match source)</label>
          <label><input type="checkbox" id="focusEyes" checked> Eyes “undull” (texture only)</label>
          <label><input type="checkbox" id="focusTattoos" checked> Tattoos (edges sharper only)</label>
          <label><input type="checkbox" id="focusMuscles"> Muscles/definition (lighting only, NO reshape)</label>
          <label><input type="checkbox" id="focusDenim" checked> Denim texture</label>
          <label><input type="checkbox" id="focusBeard" checked> Beard strands</label>
          <label><input type="checkbox" id="focusHat" checked> Hat fabric</label>
          <label><input type="checkbox" id="focusSkinEven"> Skin evenness (NO blotch, NO “clarity”)</label>
          <label><input type="checkbox" id="focusBackground" checked> Pure white background</label>
        </div>
        <p class="note">Muscles = highest drift risk. This builder will auto-lock body + forbid reshaping when you enable it.</p>
      </div>

      <div class="section">
        <div class="section-title"><span>Enhancement Style</span><span class="pill" id="stylePill">Balanced</span></div>
        <div class="row">
          <label><input type="radio" name="strength" value="subtle" id="strengthSubtle"> Subtle</label>
          <label><input type="radio" name="strength" value="balanced" id="strengthBalanced" checked> Balanced</label>
          <label><input type="radio" name="strength" value="strong" id="strengthStrong"> Strong</label>
        </div>
        <p class="note">“Strong” increases contrast/detail language (still respects locks).</p>
      </div>

      <div class="section">
        <div class="section-title"><span>Background & Shadow</span><span class="badge ok" id="bgBadge">OK</span></div>
        <div class="row">
          <label><input type="checkbox" id="whiteBG" checked> Pure white background (#FFFFFF)</label>
          <label><input type="checkbox" id="noVignette" checked> No vignette/gradient/corner darkening</label>
          <label><input type="checkbox" id="minShadow" checked> Shadow: extremely faint + ultra-soft</label>
        </div>
      </div>

      <div class="section">
        <div class="section-title"><span>Warnings / Auto-Fixes Applied</span><span class="badge" id="warnBadge">—</span></div>
        <div class="panel" id="warningsPanel">
          <div class="note" id="warningsText">No warnings.</div>
          <ul id="warningsList"></ul>
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="build">Build Prompt</button>
        <button id="copy">Copy Current</button>
        <button id="copyPass1">Copy Pass 1</button>
        <button id="copyPass2">Copy Pass 2</button>
        <button id="copyBoth">Copy Pass 1 + Pass 2</button>
        <button id="clearSaved">Clear Saved</button>
      </div>

      <div class="btnbar">
        <button class="small" id="fixEyes">Copy Fix: Eyes</button>
        <button class="small" id="fixTeeth">Copy Fix: Teeth</button>
        <button class="small" id="fixSkin">Copy Fix: Skin Tone</button>
      </div>

      <p class="note">
        Stop rule: If Pass 1 already looks great, do not run Pass 2. Most “drift” comes from unnecessary extra passes.
      </p>
    </div>

    <!-- RIGHT: Output -->
    <div class="card">
      <h2>
        <span>Generated Prompt</span>
        <span class="pill" id="pill"></span>
      </h2>
      <textarea id="output" spellcheck="false"></textarea>
      <p class="note" id="hint"></p>
    </div>

  </div>
</main>

<div class="footerhint"><div class="toast" id="toast">Copied.</div></div>

<script>
  const $ = (id) => document.getElementById(id);
  const STORAGE_KEY = "cg_all_in_prompt_builder_v1";

  function defaults(){
    return {
      aspect:"9:16",
      mode:"pass1",
      noCrop:true,
      deepDOF:true,
      noRotate:true,

      lockIdentity:true,
      lockTeeth:true,
      lockEyes:true,
      lockBeard:true,
      lockTattoos:true,
      lockBody:true,
      lockSkinPixels:false,
      colorLock:true,

      focusSmile:false,
      focusTeeth:false,
      focusEyes:true,
      focusTattoos:true,
      focusMuscles:false,
      focusDenim:true,
      focusBeard:true,
      focusHat:true,
      focusSkinEven:false,
      focusBackground:true,

      strength:"balanced",

      whiteBG:true,
      noVignette:true,
      minShadow:true,

      notes:""
    };
  }

  function readState(){
    const strength = document.querySelector('input[name="strength"]:checked')?.value || "balanced";
    return {
      aspect:$("aspect").value,
      mode:$("mode").value,
      noCrop:$("noCrop").checked,
      deepDOF:$("deepDOF").checked,
      noRotate:$("noRotate").checked,

      lockIdentity:$("lockIdentity").checked,
      lockTeeth:$("lockTeeth").checked,
      lockEyes:$("lockEyes").checked,
      lockBeard:$("lockBeard").checked,
      lockTattoos:$("lockTattoos").checked,
      lockBody:$("lockBody").checked,
      lockSkinPixels:$("lockSkinPixels").checked,
      colorLock:$("colorLock").checked,

      focusSmile:$("focusSmile").checked,
      focusTeeth:$("focusTeeth").checked,
      focusEyes:$("focusEyes").checked,
      focusTattoos:$("focusTattoos").checked,
      focusMuscles:$("focusMuscles").checked,
      focusDenim:$("focusDenim").checked,
      focusBeard:$("focusBeard").checked,
      focusHat:$("focusHat").checked,
      focusSkinEven:$("focusSkinEven").checked,
      focusBackground:$("focusBackground").checked,

      strength,

      whiteBG:$("whiteBG").checked,
      noVignette:$("noVignette").checked,
      minShadow:$("minShadow").checked,

      notes:$("notes").value.trim()
    };
  }

  function applyState(s){
    $("aspect").value = s.aspect ?? "9:16";
    $("mode").value = s.mode ?? "pass1";
    $("noCrop").checked = !!s.noCrop;
    $("deepDOF").checked = !!s.deepDOF;
    $("noRotate").checked = !!s.noRotate;

    $("lockIdentity").checked = !!s.lockIdentity;
    $("lockTeeth").checked = !!s.lockTeeth;
    $("lockEyes").checked = !!s.lockEyes;
    $("lockBeard").checked = !!s.lockBeard;
    $("lockTattoos").checked = !!s.lockTattoos;
    $("lockBody").checked = !!s.lockBody;
    $("lockSkinPixels").checked = !!s.lockSkinPixels;
    $("colorLock").checked = !!s.colorLock;

    $("focusSmile").checked = !!s.focusSmile;
    $("focusTeeth").checked = !!s.focusTeeth;
    $("focusEyes").checked = !!s.focusEyes;
    $("focusTattoos").checked = !!s.focusTattoos;
    $("focusMuscles").checked = !!s.focusMuscles;
    $("focusDenim").checked = !!s.focusDenim;
    $("focusBeard").checked = !!s.focusBeard;
    $("focusHat").checked = !!s.focusHat;
    $("focusSkinEven").checked = !!s.focusSkinEven;
    $("focusBackground").checked = !!s.focusBackground;

    $("strengthSubtle").checked = (s.strength === "subtle");
    $("strengthBalanced").checked = (s.strength === "balanced");
    $("strengthStrong").checked = (s.strength === "strong");

    $("whiteBG").checked = !!s.whiteBG;
    $("noVignette").checked = !!s.noVignette;
    $("minShadow").checked = !!s.minShadow;

    $("notes").value = s.notes ?? "";
  }

  function saveState(s){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      $("statusPill").textContent = "Saved";
    }catch{
      $("statusPill").textContent = "Not Saved";
    }
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  function clearSaved(){
    try{
      localStorage.removeItem(STORAGE_KEY);
      $("statusPill").textContent = "Cleared";
    }catch{
      $("statusPill").textContent = "Error";
    }
  }

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.style.display="none", 1200);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied.");
    }catch{
      $("output").focus(); $("output").select();
      document.execCommand("copy");
      showToast("Copied (fallback).");
    }
  }

  function setBadges(s, warnings){
    // Pills
    const map = { pass1:"Pass 1", pass2:"Pass 2", single:"Single", headshot:"Headshot" };
    $("pill").textContent = `${map[s.mode]} • ${s.aspect}`;
    $("stylePill").textContent = s.strength[0].toUpperCase() + s.strength.slice(1);

    // Badge statuses
    $("frameBadge").className = "badge ok";
    $("lockBadge").className = "badge ok";
    $("bgBadge").className = "badge ok";
    $("warnBadge").className = warnings.length ? "badge warn" : "badge ok";
    $("warnBadge").textContent = warnings.length ? `${warnings.length} note(s)` : "OK";
  }

  function warningsUI(warnings){
    const list = $("warningsList");
    list.innerHTML = "";
    if(!warnings.length){
      $("warningsText").textContent = "No warnings. Guardrails look good.";
      return;
    }
    $("warningsText").textContent = "Applied safety locks / notes:";
    warnings.forEach(w=>{
      const li = document.createElement("li");
      li.textContent = w;
      list.appendChild(li);
    });
  }

  function strengthText(strength){
    if(strength === "subtle") return {
      grade: "subtle cinematic studio grade with controlled contrast (avoid heavy drama)",
      contrast: "subtle",
      detail: "subtle",
    };
    if(strength === "strong") return {
      grade: "strong cinematic studio grade with pronounced but controlled contrast",
      contrast: "strong",
      detail: "strong",
    };
    return {
      grade: "cinematic studio grade with high-contrast but controlled highlights",
      contrast: "balanced",
      detail: "balanced",
    };
  }

  function buildPrompt(s){
    const lines = [];
    const warns = [];

    const isPass2 = s.mode === "pass2";
    const isHeadshot = s.mode === "headshot";
    const isSingle = s.mode === "single";

    // Auto-guardrails based on focus targets
    // Muscles = force lockBody + forbid reshape + lighting-only definition
    if(s.focusMuscles && !s.lockBody){
      $("lockBody").checked = true;
      s.lockBody = true;
      warns.push("Enabled Body Lock because Muscles focus was selected.");
    }
    if(s.focusSmile && !s.lockTeeth){
      $("lockTeeth").checked = true;
      s.lockTeeth = true;
      warns.push("Enabled Teeth Lock because Smile focus was selected (prevents dental drift).");
    }
    if(s.focusTeeth && !s.lockTeeth){
      $("lockTeeth").checked = true;
      s.lockTeeth = true;
      warns.push("Enabled Teeth Lock because Teeth consistency focus was selected.");
    }
    if(s.focusEyes && !s.lockEyes){
      $("lockEyes").checked = true;
      s.lockEyes = true;
      warns.push("Enabled Eyes Lock because Eyes focus was selected.");
    }
    if(s.focusSkinEven){
      // If user wants skin evenness, we do NOT want clarity on skin, and we want neutral tone lock
      if(!s.colorLock){
        $("colorLock").checked = true;
        s.colorLock = true;
        warns.push("Enabled Color Lock because Skin evenness focus was selected.");
      }
      // In Pass 2, we always lock skin pixels. In Pass 1, we can keep skin editable but forbid clarity.
      // Do not force skin pixel lock in Pass 1, but we will add explicit anti-clarity.
    }

    // Pass 2 auto skin lock for anti-blotch
    if(isPass2 && !s.lockSkinPixels){
      $("lockSkinPixels").checked = true;
      s.lockSkinPixels = true;
      warns.push("Enabled Skin Pixels Lock for Pass 2 to prevent blotchiness.");
    }

    // 1) Hard constraints first
    if(isPass2){
      lines.push(`REFINE THE PROVIDED IMAGE WITHOUT ANY FRAMING CHANGES. Preserve the ORIGINAL ${s.aspect} aspect ratio and ORIGINAL FRAMING exactly.`);
    }else{
      lines.push(`EDIT THE PROVIDED IMAGE. Preserve the ORIGINAL ${s.aspect} aspect ratio and ORIGINAL FRAMING exactly.`);
    }

    if(isHeadshot){
      lines.push("");
      lines.push("FRAMING (CROP INTENT): Create a HEADSHOT crop from the existing image. Crop in (do not extend canvas) to a head-and-shoulders composition. Keep the entire hat visible (do not cut off brim/crown). Keep full chin/jawline. Crop ends around upper chest/collarbone. CROP ANCHOR: keep eyes near the upper-third with 5–10% headroom. Do not rotate head or change camera angle.");
    }else{
      const fr = [];
      if(s.noCrop) fr.push("Do not crop, zoom, rotate, extend canvas, or recompose.");
      else fr.push("Do not extend canvas or recompose.");
      if(s.noRotate) fr.push("Do not rotate or change camera angle.");
      if(fr.length) lines.push(fr.join(" "));
    }

    // 2) Locked features
    const locks = [];
    if(s.lockIdentity) locks.push("- Preserve identity exactly: no changes to facial structure, eyes, nose, lips, jawline, or expression.");
    if(s.lockBeard) locks.push("- Beard shape locked: do not change beard outline/shape.");
    if(s.lockBody) locks.push("- No body reshaping: keep proportions, pose, clothing, and muscle definition unchanged.");
    if(s.lockTattoos) locks.push("- Tattoos locked: do not alter design or placement (edges may be sharpened if requested).");
    if(s.lockTeeth) locks.push("- Teeth locked: no whitening/straightening/reshaping/smoothing; keep shape/spacing/edges unchanged.");

    if(s.lockEyes){
      locks.push("- Eyes locked: match original eye color exactly (no hue/saturation/brightness change, no pupil change). Do not brighten/whiten sclera.");
      if(s.focusEyes){
        locks.push("- Eye enhancement allowed ONLY as iris texture/catchlight clarity within existing tones.");
      }
    }

    if(locks.length){
      lines.push("");
      lines.push("LOCKED FEATURES (CRITICAL):");
      lines.push(...locks);
    }

    // 3) Color lock (neutral on white)
    if(s.colorLock){
      lines.push("");
      lines.push("COLOR + EXPOSURE LOCK (CRITICAL): Match skin tone to the ORIGINAL source image exactly. Keep white balance neutral (no warming/cooling). Do not brighten/darken skin and do not lift midtones on skin. Keep skin hue/saturation unchanged. Do not alter skin tone/exposure to fit the white background.");
    }

    // 4) Skin lock / skin evenness instructions
    if(s.lockSkinPixels){
      lines.push("");
      lines.push("SKIN PIXELS LOCK (CRITICAL): Do not modify skin pixels at all (no clarity, no pores, no redness, no speckling, no micro-contrast).");
    }else if(s.focusSkinEven){
      lines.push("");
      lines.push("SKIN RULE: Reduce uneven redness/blotchiness subtly while preserving natural pores and realism. Do NOT add clarity/micro-contrast to skin and do NOT introduce new freckles/speckling.");
    }

    // 5) Look + detail
    const st = strengthText(s.strength);

    if(isPass2){
      lines.push("");
      lines.push("DETAIL-ONLY PASS: Do not change global exposure/contrast/white balance. Add micro-detail ONLY to specified non-skin materials. Avoid halos/oversharpening.");
      const targets = [];
      if(s.focusDenim) targets.push("denim weave/seams/rips");
      if(s.focusTattoos) targets.push("tattoo edges only (no redesign)");
      if(s.focusHat) targets.push("hat fabric texture");
      if(s.focusBeard) targets.push("beard strands (no outline change)");
      if(targets.length) lines.push("DETAIL TARGETS (NON-SKIN ONLY): " + targets.join(", ") + ".");
    } else if(isSingle){
      lines.push("");
      lines.push(`LOOK: Apply a ${st.grade} across the ENTIRE frame (not face-only): clean deep shadows, controlled highlights, realistic dynamic range, natural texture without smoothing.`);
      if(s.deepDOF) lines.push("FOCUS: Deep depth of field (even sharpness across the subject; no shallow DoF).");
      const targets = [];
      if(s.focusDenim) targets.push("denim weave/seams/rips");
      if(s.focusTattoos) targets.push("tattoo edges only (no redesign)");
      if(s.focusHat) targets.push("hat fabric texture");
      if(s.focusBeard) targets.push("beard strands (no outline change)");
      if(targets.length) lines.push("DETAIL (NON-SKIN ONLY): Increase crisp detail only on " + targets.join(", ") + ". Do not add clarity/texture to skin.");
    } else {
      lines.push("");
      lines.push(`LOOK: Apply a ${st.grade} to the ENTIRE frame (not face-only): clean deep shadows, crisp controlled highlights, realistic dynamic range, natural texture without smoothing.`);
      if(s.deepDOF) lines.push("FOCUS: Deep depth of field (even focus across the whole subject; no shallow DoF).");
    }

    // Focus targets: Smile/Teeth/Muscles (handled carefully)
    const focusLines = [];
    if(s.focusSmile){
      focusLines.push("SMILE: Maintain the same smile and mouth geometry; improve realism without changing teeth or lip shape.");
    }
    if(s.focusTeeth){
      focusLines.push("TEETH: Match teeth to the ORIGINAL source exactly (shape, spacing, edges, and color). No whitening/straightening.");
    }
    if(s.focusMuscles){
      focusLines.push("MUSCLES/DEFINITION: Enhance perceived definition ONLY via lighting/shadow and micro-contrast on clothing/fabric edges—NO anatomical reshaping, NO added muscles, NO changing body size.");
    }
    if(focusLines.length){
      lines.push("");
      lines.push("FOCUS TARGETS:");
      focusLines.forEach(l=>lines.push(l));
    }

    // 6) Background + shadow
    if(s.focusBackground || s.whiteBG || s.noVignette){
      lines.push("");
      const bgParts = [];
      if(s.whiteBG) bgParts.push("BACKGROUND: Pure uniform white (#FFFFFF) edge-to-edge.");
      if(s.noVignette) bgParts.push("NO vignette, NO gradient, NO corner darkening, NO spotlight falloff.");
      lines.push(bgParts.join(" "));
    }
    if(s.minShadow){
      lines.push("SHADOW: Remove nearly all cast shadow; allow only a faint, ultra-soft grounding shadow (barely visible).");
    }

    // 7) Negatives
    lines.push("");
    lines.push("NEGATIVE: no beauty retouching, no stylization, no face-only sharpening, no plastic smoothing, no added muscles, no feature changes.");

    // Notes
    if(s.notes){
      lines.push("");
      lines.push("NOTES: " + s.notes);
    }

    // UI warnings
    if(s.focusMuscles){
      warns.push("Muscles focus is lighting-only. If the model still reshapes, use selection/brush and target clothing edges only.");
    }
    if(s.focusSkinEven && s.lockSkinPixels){
      warns.push("Skin evenness is limited because Skin Pixels Lock is ON. Turn Skin Pixels Lock OFF for a gentle skin-evenness pass (higher drift risk).");
    }
    if(isHeadshot){
      warns.push("Headshot mode uses controlled crop. If hat gets clipped, add note: 'keep entire hat visible'.");
    }

    // Hints
    const hint = $("hint");
    if(isPass2) hint.textContent = "Pass 2 is a detail-only pass. It intentionally avoids skin edits to prevent blotchiness.";
    else if(isSingle) hint.textContent = "Single-pass is faster but can drift more than the 2-pass pipeline.";
    else hint.textContent = "";

    return { prompt: lines.join("\n"), warnings: warns };
  }

  function build(){
    const s = readState();

    // Headshot ignores noCrop
    if(s.mode === "headshot"){
      $("noCrop").checked = false;
      s.noCrop = false;
    }

    const result = buildPrompt(s);
    $("output").value = result.prompt;

    const map = { pass1:"Pass 1", pass2:"Pass 2", single:"Single", headshot:"Headshot" };
    $("pill").textContent = `${map[s.mode]} • ${s.aspect}`;
    setBadges(s, result.warnings);
    warningsUI(result.warnings);

    // Focus badge
    const anyFocus = s.focusSmile||s.focusTeeth||s.focusEyes||s.focusTattoos||s.focusMuscles||s.focusDenim||s.focusBeard||s.focusHat||s.focusSkinEven||s.focusBackground;
    $("focusBadge").textContent = anyFocus ? "Active" : "Select what matters";
    $("focusBadge").className = anyFocus ? "badge ok" : "badge";

    saveState(s);
  }

  function setBadges(s, warnings){
    $("frameBadge").className = "badge ok";
    $("lockBadge").className = "badge ok";
    $("bgBadge").className = "badge ok";
    $("warnBadge").className = warnings.length ? "badge warn" : "badge ok";
    $("warnBadge").textContent = warnings.length ? `${warnings.length} note(s)` : "OK";
  }

  function warningsUI(warnings){
    const list = $("warningsList");
    list.innerHTML = "";
    if(!warnings.length){
      $("warningsText").textContent = "No warnings. Guardrails look good.";
      return;
    }
    $("warningsText").textContent = "Applied safety locks / notes:";
    warnings.forEach(w=>{
      const li = document.createElement("li");
      li.textContent = w;
      list.appendChild(li);
    });
  }

  // Presets
  function applyPreset(name){
    const d = defaults();
    const cur = readState();
    let s = { ...d, aspect: cur.aspect || "9:16" };

    if(name === "clean"){
      s.mode = "pass1";
      s.focusDenim = false; s.focusTattoos = false; s.focusHat = false; s.focusBeard = false;
      s.focusSkinEven = false; s.focusMuscles = false; s.focusSmile = false; s.focusTeeth = false;
      s.notes = "";
    }
    if(name === "crisp"){
      s.mode = "pass1";
      s.focusDenim = true; s.focusTattoos = true; s.focusHat = true; s.focusBeard = true;
      s.focusEyes = true; s.focusBackground = true;
      s.focusSkinEven = false; s.focusMuscles = false;
      s.notes = "";
    }
    if(name === "fast"){
      s.mode = "single";
      s.focusDenim = true; s.focusTattoos = true; s.focusHat = true; s.focusBeard = true;
      s.focusEyes = true; s.focusBackground = true;
      s.notes = "";
    }
    if(name === "headshot"){
      s.mode = "headshot";
      s.noCrop = false;
      s.notes = "Keep entire hat visible.";
    }

    applyState(s);
    build();
    showToast("Preset applied.");
  }

  function applyState(s){
    $("aspect").value = s.aspect ?? "9:16";
    $("mode").value = s.mode ?? "pass1";
    $("noCrop").checked = !!s.noCrop;
    $("deepDOF").checked = !!s.deepDOF;
    $("noRotate").checked = !!s.noRotate;

    $("lockIdentity").checked = !!s.lockIdentity;
    $("lockTeeth").checked = !!s.lockTeeth;
    $("lockEyes").checked = !!s.lockEyes;
    $("lockBeard").checked = !!s.lockBeard;
    $("lockTattoos").checked = !!s.lockTattoos;
    $("lockBody").checked = !!s.lockBody;
    $("lockSkinPixels").checked = !!s.lockSkinPixels;
    $("colorLock").checked = !!s.colorLock;

    $("focusSmile").checked = !!s.focusSmile;
    $("focusTeeth").checked = !!s.focusTeeth;
    $("focusEyes").checked = !!s.focusEyes;
    $("focusTattoos").checked = !!s.focusTattoos;
    $("focusMuscles").checked = !!s.focusMuscles;
    $("focusDenim").checked = !!s.focusDenim;
    $("focusBeard").checked = !!s.focusBeard;
    $("focusHat").checked = !!s.focusHat;
    $("focusSkinEven").checked = !!s.focusSkinEven;
    $("focusBackground").checked = !!s.focusBackground;

    $("strengthSubtle").checked = (s.strength === "subtle");
    $("strengthBalanced").checked = (s.strength === "balanced");
    $("strengthStrong").checked = (s.strength === "strong");

    $("whiteBG").checked = !!s.whiteBG;
    $("noVignette").checked = !!s.noVignette;
    $("minShadow").checked = !!s.minShadow;

    $("notes").value = s.notes ?? "";
  }

  // Copy helpers for Pass 1 / Pass 2
  function asPass1State(){
    const cur = readState();
    cur.mode = "pass1";
    cur.noCrop = true;
    cur.lockSkinPixels = false;
    return cur;
  }
  function asPass2State(){
    const cur = readState();
    cur.mode = "pass2";
    cur.noCrop = true;
    cur.lockSkinPixels = true;
    return cur;
  }

  // Fix prompts
  const FIX_EYES =
`Match eye color and brightness to the ORIGINAL source exactly (no hue/sat change). Enhance only iris texture/catchlights within existing tones. Do not brighten/whiten sclera. Keep everything else unchanged.`;
  const FIX_TEETH =
`Restore teeth to match the ORIGINAL source exactly (shape, spacing, edges, color). No whitening/straightening/reshaping. Keep everything else unchanged.`;
  const FIX_SKIN =
`Restore skin tone to match the ORIGINAL source exactly. Neutral white balance. Slightly reduce lifted skin midtones/highlights without changing texture. Keep everything else unchanged.`;

  // Wire events
  $("build").addEventListener("click", build);
  $("copy").addEventListener("click", async ()=>{ if(!$("output").value.trim()) build(); await copyText($("output").value); });

  $("copyPass1").addEventListener("click", async ()=>{
    const s = asPass1State();
    const result = buildPrompt(s);
    await copyText(result.prompt);
  });
  $("copyPass2").addEventListener("click", async ()=>{
    const s = asPass2State();
    const result = buildPrompt(s);
    await copyText(result.prompt);
  });
  $("copyBoth").addEventListener("click", async ()=>{
    const p1 = buildPrompt(asPass1State()).prompt;
    const p2 = buildPrompt(asPass2State()).prompt;
    await copyText(["PASS 1:", p1, "", "PASS 2:", p2].join("\n"));
  });

  $("fixEyes").addEventListener("click", async ()=>copyText(FIX_EYES));
  $("fixTeeth").addEventListener("click", async ()=>copyText(FIX_TEETH));
  $("fixSkin").addEventListener("click", async ()=>copyText(FIX_SKIN));

  $("clearSaved").addEventListener("click", ()=>{
    clearSaved();
    applyState(defaults());
    build();
    showToast("Saved cleared.");
  });

  $("presetClean").addEventListener("click", ()=>applyPreset("clean"));
  $("presetCrisp").addEventListener("click", ()=>applyPreset("crisp"));
  $("presetFast").addEventListener("click", ()=>applyPreset("fast"));
  $("presetHeadshot").addEventListener("click", ()=>applyPreset("headshot"));

  function clearSaved(){ try{ localStorage.removeItem(STORAGE_KEY); $("statusPill").textContent="Cleared"; }catch{ $("statusPill").textContent="Error"; } }
  function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); $("statusPill").textContent="Saved"; }catch{ $("statusPill").textContent="Not Saved"; } }
  function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return null; return JSON.parse(raw);}catch{return null;} }

  // Auto build on change
  const watchIds = [
    "aspect","mode","notes","noCrop","deepDOF","noRotate",
    "lockIdentity","lockTeeth","lockEyes","lockBeard","lockTattoos","lockBody","lockSkinPixels","colorLock",
    "focusSmile","focusTeeth","focusEyes","focusTattoos","focusMuscles","focusDenim","focusBeard","focusHat","focusSkinEven","focusBackground",
    "whiteBG","noVignette","minShadow",
    "strengthSubtle","strengthBalanced","strengthStrong"
  ];
  watchIds.forEach(id => $(id).addEventListener("change", build));

  // Init
  (function init(){
    const saved = loadState();
    if(saved){
      applyState({ ...defaults(), ...saved });
      $("statusPill").textContent = "Loaded";
    }else{
      applyState(defaults());
      $("statusPill").textContent = "Saved";
    }
    build();
  })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="author" content="Nathan Histed" />
  <meta name="copyright" content="¬© 2025 Nathan Histed. All rights reserved." />
  <title>Pocket Cinema ‚Äî AI Prompt Learning Tool (¬© Nathan Histed)</title>
<nav class="nav">
  <a href="index.html">Tool</a>
  <a href="about.html">About</a>
</nav>
  <style>
    :root{
      --bg:#0b0b0f; --text:#fff; --muted:#b5b5c0; --line:#26263a;
      --accent:#6d6dff; --accent2:#8a5cff;
      --ok:#a6ffcf; --warn:#ffd38a; --bad:#ff7d7d;
      --card:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(109,109,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 80% 20%, rgba(138,92,255,.14), transparent 60%),
        var(--bg);
      color:var(--text); min-height:100vh;
    }
    .wrap{max-width:1120px; margin:0 auto; padding:22px 16px 44px;}
    .top{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      padding:14px; border:1px solid var(--line); border-radius:14px; background:var(--card);
      backdrop-filter: blur(6px);
    }
    .brand h1{margin:0; font-size:1.05rem; letter-spacing:.2px;}
    .brand p{margin:.35rem 0 0; color:var(--muted); font-size:.9rem; line-height:1.25;}
    .pill{
      border:1px solid var(--line); color:var(--muted); padding:8px 10px;
      border-radius:999px; font-size:.82rem; background:rgba(0,0,0,.18);
      display:flex; gap:8px; align-items:center;
    }
    .pill a{color:var(--accent2); text-decoration:none;}
    .pill a:hover{text-decoration:underline;}

    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px;}
    @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr;} }

    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px;}
    .card h2{margin:0 0 10px; font-size:1rem;}

    label{display:block; font-size:.85rem; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.22); color:var(--text); outline:none;
    }
    textarea{min-height:90px; resize:vertical;}

    .row{display:grid; grid-template-columns:1fr; gap:10px;}
    @media(min-width:520px){ .row{grid-template-columns:1fr 1fr;} }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border:none; border-radius:12px; padding:12px 12px; font-weight:700;
      color:#fff; background:linear-gradient(135deg, var(--accent), var(--accent2));
      cursor:pointer;
    }
    button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text);}

    .out{
      white-space:pre-wrap; word-wrap:break-word; line-height:1.35;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:rgba(0,0,0,.25); border:1px dashed rgba(255,255,255,.18);
      padding:12px; border-radius:12px; min-height:290px;
    }
    .hint{color:var(--muted); font-size:.85rem; margin-top:8px; line-height:1.35;}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .tiny{font-size:.78rem; color:var(--muted); margin-top:10px; line-height:1.4;}
    .smallLink{color:var(--accent2); text-decoration:none;}
    .smallLink:hover{text-decoration:underline;}

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:12px;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    .tab{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:.86rem;
      user-select:none;
    }
    .tab .ico{opacity:.95}
    .tab.active{
      border-color:rgba(109,109,255,.55);
      box-shadow:0 0 0 2px rgba(109,109,255,.16) inset;
      background:rgba(109,109,255,.12);
    }

    /* Guidance panel */
    .guide{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.16);
    }
    .guideHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      cursor:pointer;
      background:rgba(255,255,255,.04);
    }
    .guideHead strong{font-size:.9rem;}
    .guideBody{padding:10px 12px; border-top:1px solid rgba(255,255,255,.08);}
    .guideBody ul{margin:8px 0 0 18px; color:var(--muted); font-size:.88rem; line-height:1.35;}
    .guideBody .ex{margin-top:10px; padding:10px; border-radius:12px; border:1px dashed rgba(255,255,255,.18); background:rgba(0,0,0,.22); color:#fff; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:.85rem;}
    .hidden{display:none !important;}

    /* Optional section wrapper */
    .sectionHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:12px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .sectionHead h3{margin:0; font-size:.95rem;}
    .optionalWrap{
      margin-top:10px;
      padding:12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }

    /* Chips */
    .switchRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;}
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:.82rem;
      display:flex; align-items:center; gap:8px;
    }
    .chip input{width:auto; padding:0; margin:0;}

    /* Image pack */
    .imgGrid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; margin-top:10px;}
    @media(min-width:520px){ .imgGrid{grid-template-columns:repeat(3, 1fr);} }
    .imgCard{
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px;
      background:rgba(0,0,0,.20);
    }
    .imgTop{display:flex; gap:10px; align-items:flex-start;}
    .thumb{width:72px; height:72px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.12);}
    .imgMeta{flex:1; min-width:0;}
    .imgName{font-size:.80rem; color:var(--muted); margin:0 0 6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .miniLabel{margin:0 0 6px; font-size:.78rem; color:var(--muted);}
    .miniInput{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:#fff;
      margin-bottom:8px;
      font-size:.85rem;
    }

    /* Password Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      padding:14px;
      backdrop-filter: blur(8px);
    }
    .modalTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .modalTop h3{margin:0; font-size:1rem;}
    .modalTop p{margin:.35rem 0 0; color:var(--muted); font-size:.88rem; line-height:1.35;}
    .xBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
    }
    .modalActions{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px;}
    .modalMsg{margin-top:8px; font-size:.85rem;}

    .footer{
      margin-top:18px;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:.82rem;
      line-height:1.4;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Pocket Cinema (PCNH) ‚Äî AI Prompt Learning Tool</h1>
        <p>Created by Nathan Histed. Tabs teach you how to guide AI with constraints, clarity, and consistency.</p>
      </div>
      <div class="pill">
        <span>¬©</span><strong>Nathan Histed</strong>
        <span style="opacity:.55">‚Ä¢</span>
        <a href="./about.html">About</a>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-mode="logo"><span class="ico">‚ñ∂Ô∏è</span> Logo</div>
      <div class="tab" data-mode="enhance"><span class="ico">‚ú®</span> Enhance</div>
      <div class="tab" data-mode="edit"><span class="ico">ü™Ñ</span> Edit</div>
      <div class="tab" data-mode="album"><span class="ico">üíø</span> Album</div>
      <div class="tab" data-mode="product"><span class="ico">üì¶</span> Product</div>
      <div class="tab" data-mode="mockup"><span class="ico">üñºÔ∏è</span> Mockup</div>
      <div class="tab" data-mode="redesign"><span class="ico">üîÅ</span> Redesign</div>
      <div class="tab" data-mode="scene"><span class="ico">üé¨</span> Scene</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Inputs</h2>

        <div class="guide" id="guide">
          <div class="guideHead" id="guideToggle">
            <div><strong>‚ÑπÔ∏è How to get the best results (tap to open)</strong></div>
            <div style="opacity:.7" id="guideChevron">‚ñæ</div>
          </div>
          <div class="guideBody hidden" id="guideBody"></div>
        </div>

        <label>Platform</label>
        <select id="platform">
          <option value="gemini">Gemini (nano-banana)</option>
          <option value="grok">Grok</option>
          <option value="sora2">Sora 2</option>
          <option value="meta">Meta AI</option>
          <option value="chatgpt">ChatGPT</option>
          <option value="lmarena">LM Arena</option>
          <option value="capcut">CapCut</option>
        </select>

        <!-- AI Rewrite (optional) -->
        <div class="optionalWrap" style="margin-top:10px;">
          <div class="row">
            <div>
              <label>Rewrite Engine</label>
              <select id="rewriteMode">
                <option value="local" selected>Local Rewrite (free)</option>
                <option value="gemini">Gemini Rewrite (BYO key)</option>
              </select>
              <div class="tiny">Local is always available. Gemini is optional and requires your own key.</div>
            </div>
            <div id="geminiKeyWrap" class="hidden">
              <label>Gemini API Key (BYO)</label>
              <input id="geminiKey" placeholder="Paste your Gemini API key (stored only in your browser session)" />
              <div class="tiny">Never hardcode keys into GitHub Pages.</div>
            </div>
          </div>
        </div>

        <div class="switchRow">
          <label class="chip">
            <input type="checkbox" id="strict120" />
            <span>Strict 120-word mode (Sora-friendly)</span>
          </label>
          <label class="chip">
            <input type="checkbox" id="verbose" checked />
            <span>Verbose details</span>
          </label>
        </div>

        <label>Plain & Simple starter (optional, recommended)</label>
        <input id="plainStarter" placeholder="One sentence. Example: 'Neon Pocket Cinema logo with NH play icon and PROMPT‚Äôr tagline'" />
        <div class="tiny">If you‚Äôre stuck, just write one sentence. The rewrite engine will do the rest.</div>

        <label>Raw notes (optional)</label>
        <textarea id="rawNotes" placeholder="Any extra thoughts, references, constraints, words you want included‚Ä¶"></textarea>

        <!-- Album required fields -->
        <div id="albumReqWrap" class="optionalWrap hidden">
          <div class="row">
            <div>
              <label>Artist Name <span class="warn">*</span></label>
              <input id="albumArtist" placeholder="Required for Album tab" />
            </div>
            <div>
              <label>Title <span class="warn">*</span></label>
              <input id="albumTitle" placeholder="Required for Album tab" />
            </div>
          </div>
          <div class="tiny">Album covers are always square (1:1). Artist + Title must be spelled exactly.</div>
        </div>

        <!-- Framing control (Edit / Redesign) -->
        <div id="frameWrap" class="optionalWrap hidden">
          <label>Reference Framing</label>
          <select id="framingMode">
            <option value="same" selected>Match original framing/size (most consistent)</option>
            <option value="slight">Slightly different angle (still consistent)</option>
          </select>
          <div class="tiny">Only two options by design (prevents AI drift).</div>
        </div>

        <div class="row">
          <div>
            <label>Subject</label>
            <input id="subject" placeholder="e.g., Pocket Cinema wordmark, a portrait photo, product, scene concept" />
          </div>
          <div>
            <label>Setting / Background</label>
            <input id="setting" placeholder="e.g., dark studio, neon city, seamless backdrop, textured paper" />
          </div>
        </div>

        <div class="sectionHead">
          <h3>Creative controls</h3>
          <button class="secondary" id="toggleCreative" type="button">Hide</button>
        </div>

        <div id="creativeWrap" class="optionalWrap">
          <div class="row">
            <div>
              <label>Vibe</label>
              <select id="vibeSelect">
                <option value="" selected>None (omit)</option>
                <option value="Cinematic">Cinematic</option>
                <option value="Futuristic Minimal">Futuristic Minimal</option>
                <option value="Luxury / High-end">Luxury / High-end</option>
                <option value="Gritty / Street">Gritty / Street</option>
                <option value="Dreamy / Soft">Dreamy / Soft</option>
                <option value="__custom__">Custom‚Ä¶</option>
              </select>
              <input id="vibeCustom" class="hidden" placeholder="Type your vibe‚Ä¶" />
            </div>

            <div>
              <label>Lighting</label>
              <select id="lightingSelect">
                <option value="" selected>None (omit)</option>
                <option value="Softbox studio, clean highlights">Softbox studio, clean highlights</option>
                <option value="Flash-lit paparazzi, crisp speculars">Flash-lit paparazzi, crisp speculars</option>
                <option value="Golden hour, warm rim light">Golden hour, warm rim light</option>
                <option value="Neon accents, high contrast">Neon accents, high contrast</option>
                <option value="Moody low-key, dramatic shadows">Moody low-key, dramatic shadows</option>
                <option value="__custom__">Custom‚Ä¶</option>
              </select>
              <input id="lightingCustom" class="hidden" placeholder="Type your lighting‚Ä¶" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Camera / Lens</label>
              <select id="lensSelect">
                <option value="" selected>None (omit)</option>
                <option value="35mm documentary">35mm documentary</option>
                <option value="50mm portrait">50mm portrait</option>
                <option value="85mm compression">85mm compression</option>
                <option value="24mm wide hero shot">24mm wide hero shot</option>
                <option value="__custom__">Custom‚Ä¶</option>
              </select>
              <input id="lensCustom" class="hidden" placeholder="Type your camera/lens‚Ä¶" />
              <div class="tiny" id="lensNote">Tip: Logos/Album covers usually don‚Äôt need lens language.</div>
            </div>

            <div>
              <label>Aspect Ratio</label>
              <select id="arSelect">
                <option value="" selected>None (omit)</option>
                <option value="1:1">1:1</option>
                <option value="4:5">4:5</option>
                <option value="9:16">9:16</option>
                <option value="16:9">16:9</option>
                <option value="__custom__">Custom‚Ä¶</option>
              </select>
              <input id="arCustom" class="hidden" placeholder="Type your aspect ratio‚Ä¶" />
              <div class="tiny" id="arNote">Album tab forces 1:1 automatically.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Quality</label>
              <select id="qualitySelect">
                <option value="" selected>None (omit)</option>
                <option value="Ultra-detailed, realistic texture">Ultra-detailed, realistic texture</option>
                <option value="Clean, polished, minimal grain">Clean, polished, minimal grain</option>
                <option value="Film grain, editorial realism">Film grain, editorial realism</option>
                <option value="__custom__">Custom‚Ä¶</option>
              </select>
              <input id="qualityCustom" class="hidden" placeholder="Type your quality instruction‚Ä¶" />
            </div>

            <div>
              <label>Text overlay (optional)</label>
              <input id="overlay" placeholder='e.g., "ULTIMATE IMAGE PROMPT‚Äôr" bottom-center, bold sans' />
            </div>
          </div>

          <label>Key details (optional)</label>
          <textarea id="details" placeholder="Colors, layout notes, typography intent, props, materials, do/don‚Äôt‚Ä¶"></textarea>
        </div>

        <label>Reference Images (0‚Äì10)</label>
        <input id="imgFiles" type="file" accept="image/*" multiple />
        <div class="tiny">Images stay in your browser. Label them below to make prompts smarter.</div>
        <div id="imgPreview" class="imgGrid"></div>

        <div class="btns">
          <button id="gen" type="button">Generate</button>
          <button class="secondary" id="shorten" type="button">Shorten</button>
          <button class="secondary" id="copy" type="button">Copy</button>
          <button class="secondary" id="clear" type="button">Clear</button>
        </div>

        <div class="tiny">
          Tip: For real people, use only your own/owned images and avoid naming people you don‚Äôt have rights to.
        </div>
      </div>

      <div class="card">
        <h2>Output</h2>
        <div id="output" class="out">Pick a tab, fill what you can, then tap ‚ÄúGenerate‚Äù.</div>
        <div id="status" class="hint"></div>
        <div class="hint"><span class="ok">‚úì</span> Client-side only. Images stay in your browser.</div>

        <div class="footer">
          ¬© 2025 Nathan Histed ‚Äî Pocket Cinema (PCNH). All rights reserved.<br/>
          This tool, its UI patterns, and prompt formats are proprietary to Nathan Histed.
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="pwBackdrop" class="modalBackdrop hidden" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
    <div class="modal">
      <div class="modalTop">
        <div>
          <h3 id="pwTitle">üîí Password Required</h3>
          <p>Enter the access password to run this action.</p>
        </div>
        <button class="xBtn" id="pwClose" type="button">‚úï</button>
      </div>

      <label>Password</label>
      <input id="pwInput" type="password" placeholder="Enter password‚Ä¶" autocomplete="off" />
      <div id="pwMsg" class="modalMsg tiny"></div>

      <div class="modalActions">
        <button class="secondary" id="pwCancel" type="button">Cancel</button>
        <button id="pwSubmit" type="button">Continue</button>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ===== Password Gate (Generate + Shorten only) =====
  const ACCESS_PASSWORD = "PROMPT";
  let pendingAction = null;

  function openPasswordModal(actionFn){
    pendingAction = actionFn;
    $("pwMsg").textContent = "";
    $("pwInput").value = "";
    $("pwBackdrop").classList.remove("hidden");
    setTimeout(() => $("pwInput").focus(), 60);
  }
  function closePasswordModal(){
    pendingAction = null;
    $("pwBackdrop").classList.add("hidden");
  }
  function submitPassword(){
    const entered = ($("pwInput").value || "").trim();
    if(entered !== ACCESS_PASSWORD){
      $("pwMsg").innerHTML = `<span class="bad">Incorrect password.</span>`;
      $("pwInput").value = "";
      $("pwInput").focus();
      return;
    }
    const fn = pendingAction;
    closePasswordModal();
    if(typeof fn === "function") fn();
  }
  $("pwSubmit").addEventListener("click", submitPassword);
  $("pwCancel").addEventListener("click", closePasswordModal);
  $("pwClose").addEventListener("click", closePasswordModal);
  $("pwInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter") submitPassword();
    if(e.key === "Escape") closePasswordModal();
  });
  $("pwBackdrop").addEventListener("click", (e) => {
    if(e.target === $("pwBackdrop")) closePasswordModal();
  });

  // ===== Helpers =====
  function wordCount(text){
    return text.trim().split(/\s+/).filter(Boolean).length;
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function bindCustomSelect(selectId, customId){
    const sel = $(selectId), custom = $(customId);
    function sync(){
      const isCustom = sel.value === "__custom__";
      custom.classList.toggle("hidden", !isCustom);
      if(isCustom) setTimeout(() => custom.focus(), 50);
    }
    sel.addEventListener("change", sync);
    sync();
  }
  function selectValue(selectId, customId){
    const sel = $(selectId).value;
    if(sel === "") return "";
    if(sel === "__custom__") return ($(customId).value || "").trim();
    return sel.trim();
  }

  bindCustomSelect("vibeSelect","vibeCustom");
  bindCustomSelect("lightingSelect","lightingCustom");
  bindCustomSelect("lensSelect","lensCustom");
  bindCustomSelect("arSelect","arCustom");
  bindCustomSelect("qualitySelect","qualityCustom");

  // ===== Modes (tabs) =====
  const GUIDES = {
    logo: {
      title: "LOGO / TYPOGRAPHY",
      focus: ["Clear brand name", "Readable typography", "Simple geometry", "Icon + wordmark balance"],
      avoid: ["Photorealism", "Faces/hands", "Busy backgrounds", "Misspelled/warped text"],
      example: "Minimal logo for POCKET CINEMA with a play-button icon and integrated NH monogram, clean vector geometry, sharp typography, dark background with subtle ultraviolet neon accent."
    },
    enhance: {
      title: "PHOTO ENHANCE (DETAIL-FOCUSED)",
      focus: ["Micro-detail clarity", "Natural texture (skin/fabric/surfaces)", "Balanced highlights/shadows", "Natural sharpening + noise reduction"],
      avoid: ["Changing identity", "Changing crop/angle", "Adding/removing objects", "Over-smoothing (plastic)"],
      example: "Enhance only: restore fine detail and natural texture, improve clarity and dynamic range, reduce noise naturally, preserve original framing and identity exactly."
    },
    edit: {
      title: "PHOTO EDIT (MANIPULATION)",
      focus: ["Controlled changes", "Seamless blending", "Matched lighting/perspective", "Respect the reference image"],
      avoid: ["Major framing changes", "Identity drift", "Random additions", "Mismatched shadows/scale"],
      example: "Replace background with a neon-lit city alley, keep the subject identical, match original framing, maintain realistic lighting and perspective."
    },
    album: {
      title: "ALBUM COVER",
      focus: ["Strong central concept", "Artist + Title clarity", "Cohesive mood", "Print-ready composition"],
      avoid: ["Non-square layouts", "Cluttered typography", "Unreadable text", "Busy backgrounds behind text"],
      example: "Square (1:1) album cover for artist 'Nathan Histed' titled 'Pocket Cinema', dark cinematic mood, ultraviolet neon accents, bold clean typography, print-ready layout."
    },
    product: {
      title: "PRODUCT DESIGN",
      focus: ["Accurate proportions", "Material realism", "Clean silhouette", "Premium presentation"],
      avoid: ["Impossible geometry", "Warped logos/text", "Unrealistic materials", "Noisy clutter"],
      example: "Premium product design for a minimalist camera accessory, matte black aluminum, clean edges, realistic lighting, isolated on a dark background."
    },
    mockup: {
      title: "MOCKUP",
      focus: ["Correct perspective", "Realistic placement", "Natural shadows/lighting", "Believable materials"],
      avoid: ["Floating designs", "Warped prints", "Incorrect angles", "Overly glossy glare"],
      example: "T-shirt mockup showing the logo printed on black fabric, realistic folds, natural shadows, accurate print texture, studio lighting."
    },
    redesign: {
      title: "REDESIGN",
      focus: ["Improve clarity/quality", "Preserve original intent", "Modernize without losing identity", "Clean structure"],
      avoid: ["Changing core concept", "Random style shifts", "Overcomplication", "Losing recognizability"],
      example: "Redesign this logo to be more modern and minimal while keeping the original concept and name recognizable."
    },
    scene: {
      title: "SCENE / CONCEPT",
      focus: ["Mood and storytelling", "Composition and lighting", "Cinematic realism", "Clear subject focus"],
      avoid: ["Visual clutter", "Conflicting styles", "Overly vague prompts", "Too many elements"],
      example: "Cinematic nighttime scene of a creator under neon lights, moody atmosphere, shallow depth of field, realistic lighting and texture."
    }
  };

  let currentMode = "logo";
  let guideOpen = false;

  function setGuide(mode){
    const g = GUIDES[mode] || GUIDES.scene;
    const body = `
      <div style="color:#fff; font-weight:800; letter-spacing:.2px;">${escapeHtml(g.title)}</div>
      <ul><li><strong style="color:#fff;">Focus on:</strong> ${escapeHtml(g.focus.join("; "))}</li></ul>
      <ul><li><strong style="color:#fff;">Avoid:</strong> ${escapeHtml(g.avoid.join("; "))}</li></ul>
      <div class="ex"><strong>Example:</strong> ${escapeHtml(g.example)}</div>
    `;
    $("guideBody").innerHTML = body;
  }

  $("guideToggle").addEventListener("click", () => {
    guideOpen = !guideOpen;
    $("guideBody").classList.toggle("hidden", !guideOpen);
    $("guideChevron").textContent = guideOpen ? "‚ñ¥" : "‚ñæ";
  });

  function syncModeUI(){
    // Album required
    const isAlbum = currentMode === "album";
    $("albumReqWrap").classList.toggle("hidden", !isAlbum);

    // Framing for edit/redesign
    const showFrame = ["edit","redesign"].includes(currentMode);
    $("frameWrap").classList.toggle("hidden", !showFrame);

    // Force AR 1:1 for album
    if(isAlbum){
      $("arSelect").value = "1:1";
      $("arCustom").value = "";
      $("arCustom").classList.add("hidden");
      $("arSelect").disabled = true;
      $("arNote").textContent = "Album tab locks AR to 1:1.";
    } else {
      $("arSelect").disabled = false;
      $("arNote").textContent = "Album tab forces 1:1 automatically.";
    }

    // Lens note for logo/album
    $("lensNote").textContent = (["logo","album"].includes(currentMode))
      ? "Tip: Logos/Album covers usually don‚Äôt need lens language."
      : "Tip: Lens language helps photography/scene realism.";

    // Guide content
    setGuide(currentMode);
  }

  // Tabs click
  $("tabs").querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      $("tabs").querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      currentMode = t.getAttribute("data-mode");
      syncModeUI();
      $("status").innerHTML = `<span class="ok">‚úì</span> Mode set to <strong>${escapeHtml(GUIDES[currentMode].title)}</strong>`;
    });
  });

  // ===== Creative controls hide/show =====
  let creativeVisible = true;
  function setCreativeVisible(v){
    creativeVisible = v;
    $("creativeWrap").classList.toggle("hidden", !v);
    $("toggleCreative").textContent = v ? "Hide" : "Show";
  }
  $("toggleCreative").addEventListener("click", () => setCreativeVisible(!creativeVisible));

  // ===== Gemini key visibility =====
  function syncRewriteUI(){
    const isGemini = $("rewriteMode").value === "gemini";
    $("geminiKeyWrap").classList.toggle("hidden", !isGemini);
  }
  $("rewriteMode").addEventListener("change", syncRewriteUI);
  syncRewriteUI();

  // ===== Image pack (local only) =====
  let imagePack = []; // {name, dataUrl, role, keep, change}

  function clampImages(files){ return Array.from(files || []).slice(0, 10); }
  function roleOption(label, current){
    const selected = (label === current) ? "selected" : "";
    return `<option ${selected}>${label}</option>`;
  }
  function renderImagePack(){
    const wrap = $("imgPreview");
    wrap.innerHTML = "";
    imagePack.forEach((img, idx) => {
      const el = document.createElement("div");
      el.className = "imgCard";
      el.innerHTML = `
        <div class="imgTop">
          <img class="thumb" src="${img.dataUrl}" alt="img${idx+1}" />
          <div class="imgMeta">
            <div class="imgName">Image ${idx+1}: ${escapeHtml(img.name)}</div>

            <div class="miniLabel">Role</div>
            <select class="miniInput" data-idx="${idx}" data-field="role">
              ${roleOption("Primary subject/identity", img.role)}
              ${roleOption("Wardrobe/texture", img.role)}
              ${roleOption("Background/location", img.role)}
              ${roleOption("Lighting/color grade", img.role)}
              ${roleOption("Style reference", img.role)}
              ${roleOption("Text/logo reference", img.role)}
            </select>

            <div class="miniLabel">Keep</div>
            <input class="miniInput" data-idx="${idx}" data-field="keep" value="${escapeHtml(img.keep||"")}" placeholder="What must stay the same?" />

            <div class="miniLabel">Change</div>
            <input class="miniInput" data-idx="${idx}" data-field="change" value="${escapeHtml(img.change||"")}" placeholder="What should be different?" />
          </div>
        </div>
      `;
      wrap.appendChild(el);
    });

    wrap.querySelectorAll("select, input").forEach(node => {
      node.addEventListener("input", () => {
        const i = Number(node.getAttribute("data-idx"));
        const field = node.getAttribute("data-field");
        imagePack[i][field] = node.value;
      });
    });
  }

  $("imgFiles").addEventListener("change", async (e) => {
    const files = clampImages(e.target.files);
    imagePack = [];
    for(const f of files){
      const dataUrl = await new Promise((res) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(f);
      });
      imagePack.push({
        name: f.name || "image",
        dataUrl,
        role: "Primary subject/identity",
        keep: "",
        change: ""
      });
    }
    renderImagePack();
  });

  function buildImageInstructions(){
    if(!imagePack.length) return "";
    const lines = imagePack.map((img, i) => {
      const keep = img.keep ? ` Keep: ${img.keep}.` : "";
      const change = img.change ? ` Change: ${img.change}.` : "";
      return `Image ${i+1} ‚Äî Role: ${img.role}.${keep}${change}`.trim();
    });
    return ["Reference Images (local):", ...lines].join("\n");
  }

  // ===== Locked prompt rules by mode =====
  function modeRules(mode){
    const verbose = $("verbose").checked;

    const base = {
      constraints: [],
      avoid: "",
      useNegativeLine: true
    };

    if(mode === "logo"){
      base.constraints.push(
        "Design constraints: clean vector geometry, sharp typography, correct spelling, balanced spacing, high legibility.",
        "No photorealism. No faces. Minimal shapes. Brand-ready mark."
      );
      base.avoid = "Avoid: distorted letters, misspellings, messy gradients, random extra symbols, low-res edges.";
      base.useNegativeLine = false;
      return base;
    }

    if(mode === "album"){
      const artist = ($("albumArtist").value || "").trim();
      const title = ($("albumTitle").value || "").trim();
      base.constraints.push(
        "Album cover rules: square 1:1 composition, print-ready layout, strong focal point, intentional typography.",
        artist && title ? `Text on cover (exact spelling): Artist "${artist}", Title "${title}".` : "Text on cover: Artist + Title required."
      );
      base.avoid = "Avoid: unreadable typography, clutter behind text, non-square layouts, misspellings, low-res artifacts.";
      return base;
    }

    if(mode === "enhance"){
      base.constraints.push(
        "Enhancement only: do not change identity, do not add/remove objects, do not change pose/angle/crop.",
        verbose
          ? "Detail focus: recover micro-texture (skin/fabric/surfaces), natural sharpening, noise reduction, improved dynamic range, realistic color balance."
          : "Detail focus: natural clarity, texture, noise reduction, balanced tone."
      );
      base.avoid = "Avoid: plastic skin, heavy smoothing, HDR halos, invented details, face changes, cropping changes.";
      return base;
    }

    if(mode === "edit" || mode === "redesign"){
      const framing = $("framingMode").value;
      base.constraints.push(
        "Editing rules: match lighting, perspective, and texture for seamless compositing.",
        framing === "same"
          ? "Framing rule: match original framing, crop, and output size exactly."
          : "Framing rule: allow a slightly different angle while keeping scale/identity consistent; avoid drastic aspect ratio changes."
      );
      base.avoid = "Avoid: jagged cutouts, halos, mismatched shadows, scale errors, identity drift, AI artifacts.";
      return base;
    }

    if(mode === "product"){
      base.constraints.push(
        "Product design: accurate proportions, premium materials, clean silhouette, believable reflections and surfaces.",
        "Presentation: uncluttered composition that highlights the product."
      );
      base.avoid = "Avoid: impossible geometry, melted surfaces, warped logos/text, inconsistent reflections, noisy backgrounds.";
      return base;
    }

    if(mode === "mockup"){
      base.constraints.push(
        "Mockup rules: correct perspective mapping, realistic material/print texture, natural lighting and shadows.",
        "Design must look applied (not floating). Keep typography/logos undistorted."
      );
      base.avoid = "Avoid: warped placement, floating prints, incorrect perspective, extreme glare, unreadable text.";
      return base;
    }

    // scene default
    base.constraints.push(
      "Scene rules: coherent lighting, believable materials, strong composition, clear subject focus."
    );
    base.avoid = "Avoid: warped text, heavy blur, low-res artifacts, inconsistent lighting, clutter.";
    return base;
  }

  function validateRequired(){
    if(currentMode === "album"){
      const a = ($("albumArtist").value || "").trim();
      const t = ($("albumTitle").value || "").trim();
      if(!a || !t){
        $("status").innerHTML = `<span class="bad">Album requires Artist Name + Title.</span>`;
        $("albumReqWrap").classList.remove("hidden");
        return false;
      }
    }
    return true;
  }

  // ===== Locked rewrite: local + optional Gemini =====
  function gatherFields(){
    const subjectRaw = ($("subject").value || "").trim();
    const settingRaw = ($("setting").value || "").trim();
    const plain = ($("plainStarter").value || "").trim();
    const notes = ($("rawNotes").value || "").trim();

    const vibe = selectValue("vibeSelect","vibeCustom");
    const lighting = selectValue("lightingSelect","lightingCustom");
    const lens = selectValue("lensSelect","lensCustom");
    const quality = selectValue("qualitySelect","qualityCustom");
    const ar = selectValue("arSelect","arCustom");
    const overlay = ($("overlay").value || "").trim();
    const details = ($("details").value || "").trim();

    const albumArtist = ($("albumArtist").value || "").trim();
    const albumTitle = ($("albumTitle").value || "").trim();

    return {
      subject: subjectRaw || "",
      setting: settingRaw || "",
      plain, notes,
      vibe, lighting, lens, quality, ar,
      overlay, details,
      albumArtist, albumTitle
    };
  }

  function localRewrite(mode, fields){
    // This is the locked, mode-safe rewrite.
    const r = modeRules(mode);
    const parts = [];

    // Use a strong anchor: either subject/setting, or plain starter
    const anchor = fields.plain || fields.subject || "a subject";
    const setting = fields.setting || "a fitting environment";

    // Mode-aware header
    const header = {
      logo: "Logo design prompt",
      enhance: "Photo enhancement prompt",
      edit: "Photo manipulation/edit prompt",
      album: "Album cover prompt",
      product: "Product design prompt",
      mockup: "Mockup prompt",
      redesign: "Redesign prompt",
      scene: "Scene/concept prompt"
    }[mode] || "Prompt";

    parts.push(`${header} (Pocket Cinema / PCNH ‚Äî ¬© Nathan Histed).`);

    // Required album text
    if(mode === "album"){
      parts.push(`Artist: ${fields.albumArtist}. Title: ${fields.albumTitle}.`);
      parts.push("Aspect ratio: 1:1 (square album cover).");
    }

    // Primary intent
    parts.push(`Core intent: ${anchor}.`);
    parts.push(`Setting/background: ${setting}.`);

    // Creative controls (optional)
    if(fields.vibe) parts.push(`Vibe/style: ${fields.vibe}.`);
    if(fields.lighting) parts.push(`Lighting: ${fields.lighting}.`);

    // Lens language is often noise for logo/album/enhance; keep only if user explicitly set it AND mode benefits
    const lensAllowed = !["logo","album"].includes(mode);
    if(fields.lens && lensAllowed) parts.push(`Camera/lens: ${fields.lens}.`);

    if(fields.quality) parts.push(`Quality: ${fields.quality}.`);

    // AR rules: album forced; enhance/edit should preserve unless user asked
    if(mode !== "album" && fields.ar){
      parts.push(`Aspect ratio: ${fields.ar}.`);
    }

    if(fields.overlay){
      parts.push(`Text overlay: ${fields.overlay}.`);
    }

    // Mode rules + constraints
    r.constraints.forEach(c => parts.push(c));

    // Reference framing options are already in constraints; add a gentle reminder if images exist
    const imgBlock = buildImageInstructions();
    if(imgBlock) parts.push(imgBlock);

    if(fields.details) parts.push(`Must include: ${fields.details}.`);
    if(fields.notes) parts.push(`Notes: ${fields.notes}.`);

    // ‚ÄúAvoid‚Äù guidance (negative line only where useful)
    if(r.useNegativeLine && r.avoid) parts.push(`Avoid: ${r.avoid.replace(/^Avoid:\s*/i,"")}`);
    else if(!r.useNegativeLine && r.avoid) parts.push(`Avoid list: ${r.avoid.replace(/^Avoid:\s*/i,"")}`);

    return parts.join("\n");
  }

  async function geminiRewrite(mode, fields){
    const key = ($("geminiKey").value || "").trim();
    if(!key) throw new Error("Missing Gemini API key.");

    const r = modeRules(mode);
    const imgBlock = buildImageInstructions();

    const system = `
You are Pocket Cinema (PCNH), a learning-first prompt rewriting assistant.
Rewrite user inputs into a single, clear, high-quality prompt for the selected mode.
Rules:
- Respect the mode constraints.
- Keep it concise but strong.
- Do not invent facts.
- If mode is Enhance: enhancement only; no identity/crop changes.
- If mode is Album: enforce 1:1 and include Artist + Title exactly.
- If mode is Logo: no photorealism; focus on vector/typography; correct spelling.
Return plain text only (no markdown).
`.trim();

    const payload = {
      contents: [{
        role: "user",
        parts: [{
          text:
`MODE: ${mode}
PLAIN STARTER: ${fields.plain || ""}
SUBJECT: ${fields.subject || ""}
SETTING: ${fields.setting || ""}
VIBE: ${fields.vibe || ""}
LIGHTING: ${fields.lighting || ""}
LENS: ${fields.lens || ""}
QUALITY: ${fields.quality || ""}
ASPECT RATIO: ${mode==="album" ? "1:1 (locked)" : (fields.ar || "")}
OVERLAY: ${fields.overlay || ""}
DETAILS: ${fields.details || ""}
NOTES: ${fields.notes || ""}
ALBUM ARTIST: ${fields.albumArtist || ""}
ALBUM TITLE: ${fields.albumTitle || ""}

CONSTRAINTS:
- ${r.constraints.join("\n- ")}

AVOID:
- ${r.avoid || "(none)"}

${imgBlock ? ("\n" + imgBlock) : ""}
`
        }]
      }],
      systemInstruction: { role: "system", parts: [{ text: system }] },
      generationConfig: { temperature: 0.35, maxOutputTokens: 700 }
    };

    // Gemini Generative Language API endpoint (key in querystring)
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(key)}`;

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`Gemini error (${res.status}): ${t || "Request failed"}`);
    }

    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
    return (text || "").trim();
  }

  // ===== Output formatting per platform =====
  function formatByPlatform(platform, rewrittenText){
    const wc = wordCount(rewrittenText);

    if(platform === "sora2"){
      // Sora likes one block; 120-word mode is handled elsewhere
      return `SORA 2 (single prompt block)\n\n${rewrittenText}`;
    }
    if(platform === "capcut"){
      const overlay = ($("overlay").value || "").trim() || "Pocket Cinema";
      return [
        "CAPCUT (paste-ready blocks)",
        `Caption:\n${overlay}`,
        `Scene prompt:\n${rewrittenText}`,
        "Hashtags (optional):\n#PocketCinema #PCNH #AIPrompts #CreatorTools"
      ].join("\n\n");
    }
    if(platform === "lmarena"){
      return `LM ARENA\n\n${rewrittenText}`;
    }
    if(platform === "gemini"){
      return `GEMINI (nano-banana)\n\n${rewrittenText}`;
    }
    if(platform === "meta"){
      return `META AI\n\n${rewrittenText}`;
    }
    if(platform === "grok"){
      return `GROK\n\n${rewrittenText}`;
    }
    return `CHATGPT\n\n${rewrittenText}`;
  }

  function enforce120(text){
    const words = text.trim().split(/\s+/).filter(Boolean);
    if(words.length <= 120) return text;

    // Keep header lines if present, then trim the rest
    const lines = text.split("\n");
    const head = [];
    const body = [];
    for(const ln of lines){
      if(ln.toUpperCase().includes("SORA 2")) head.push(ln);
      else body.push(ln);
    }
    const joined = body.join(" ").replace(/\s+/g," ").trim();
    const trimmed = joined.split(" ").slice(0, 120).join(" ");
    return (head.length ? head.join("\n") + "\n\n" : "") + trimmed;
  }

  function render(text){
    $("output").textContent = text;
    const wc = wordCount(text);
    let status = `Word count: <strong>${wc}</strong>`;
    if($("strict120").checked){
      status += wc <= 120 ? ` ‚Äî <span class="ok">within 120</span>` : ` ‚Äî <span class="warn">over 120 (tap Shorten)</span>`;
    }
    $("status").innerHTML = status;
  }

  async function buildRewritten(){
    const fields = gatherFields();
    const rewriteMode = $("rewriteMode").value;

    // If user left everything empty, gently guide
    const hasAny = Object.values(fields).some(v => (typeof v === "string" ? v.trim() : v));
    if(!hasAny){
      return localRewrite(currentMode, { ...fields, plain: "Start with a clear one-sentence intent." });
    }

    if(rewriteMode === "gemini"){
      return await geminiRewrite(currentMode, fields);
    }
    return localRewrite(currentMode, fields);
  }

  async function doGenerate(){
    if(!validateRequired()) return;

    $("status").innerHTML = `Working‚Ä¶`;
    try{
      const rewritten = await buildRewritten();
      const formatted = formatByPlatform($("platform").value, rewritten);
      const finalText = $("strict120").checked ? enforce120(formatted) : formatted;
      render(finalText);
      $("status").innerHTML = `<span class="ok">‚úì</span> Generated.`;
    }catch(e){
      $("status").innerHTML = `<span class="bad">Error:</span> ${escapeHtml(e.message || String(e))}`;
    }
  }

  async function doShorten(){
    if(!validateRequired()) return;

    $("status").innerHTML = `Working‚Ä¶`;
    try{
      const rewritten = await buildRewritten();
      const formatted = formatByPlatform($("platform").value, rewritten);
      const finalText = enforce120(formatted);
      render(finalText);
      $("status").innerHTML = `<span class="ok">‚úì</span> Shortened to ‚â§120 words.`;
    }catch(e){
      $("status").innerHTML = `<span class="bad">Error:</span> ${escapeHtml(e.message || String(e))}`;
    }
  }

  async function doCopy(){
    const text = $("output").textContent;
    try{
      await navigator.clipboard.writeText(text);
      $("status").innerHTML = `<span class="ok">‚úì</span> Copied to clipboard.`;
    }catch(e){
      $("status").innerHTML = `<span class="warn">‚ö†</span> Copy failed. Press and hold output to copy manually.`;
    }
  }

  function doClear(){
    // reset basics
    $("platform").value = "gemini";
    $("rewriteMode").value = "local";
    $("geminiKey").value = "";
    syncRewriteUI();

    $("plainStarter").value = "";
    $("rawNotes").value = "";
    $("subject").value = "";
    $("setting").value = "";

    // creative controls
    $("vibeSelect").value = ""; $("vibeCustom").value = ""; $("vibeCustom").classList.add("hidden");
    $("lightingSelect").value = ""; $("lightingCustom").value = ""; $("lightingCustom").classList.add("hidden");
    $("lensSelect").value = ""; $("lensCustom").value = ""; $("lensCustom").classList.add("hidden");
    $("arSelect").value = ""; $("arCustom").value = ""; $("arCustom").classList.add("hidden");
    $("qualitySelect").value = ""; $("qualityCustom").value = ""; $("qualityCustom").classList.add("hidden");

    $("overlay").value = "";
    $("details").value = "";

    // album
    $("albumArtist").value = "";
    $("albumTitle").value = "";

    // framing
    $("framingMode").value = "same";

    // toggles
    $("strict120").checked = false;
    $("verbose").checked = true;

    // images
    $("imgFiles").value = "";
    imagePack = [];
    renderImagePack();

    // output
    $("output").textContent = "Pick a tab, fill what you can, then tap ‚ÄúGenerate‚Äù.";
    $("status").textContent = "";

    // mode re-sync
    syncModeUI();
  }

  // Buttons
  $("gen").addEventListener("click", () => openPasswordModal(doGenerate));
  $("shorten").addEventListener("click", () => openPasswordModal(doShorten));
  $("copy").addEventListener("click", () => { doCopy(); });     // no password
  $("clear").addEventListener("click", () => { doClear(); });   // no password

  // Initial
  syncModeUI();
  setGuide(currentMode);
</script>
</body>
</html>
